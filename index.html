<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="chessboardjs-1/js/chessboard-1.0.0.js"></script>
    <script src="fetcher.js"></script>
    <style>
        .content {
            max-width: 500px;
            margin: auto;
        }
    </style>
</head>
<link rel="stylesheet" href="chessboardjs-1/css/chessboard-1.0.0.min.css">

<body>
    <div class="content">
        <div id="board" style="width: 400px"></div>
        <p>Einfach ziehen und warten...</p>
        <!-- <input type="text" id="input_move"/>
        <button id="moveBtn">Los!</button> -->
        <p id="last_time"></p>
        <p id="last_move"></p>
        <p id="player_turn"></p>
        <button id="castle_queenside_button">Rochade links</button>
        <button id="castle_kingside_button">Rochade rechts</button>
    </div>

</body>
<!-- <script src="jquery.min.js"></script> -->

<script type="text/javascript">
    var turn = true;

    function updatePlayerTurn() {
        $("#player_turn").text(turn ? "WeiÃŸ am Zug" : "Schwarz am Zug")
    }

    function onDrop(source, target, piece, newPos, oldPos, orientation) {
        console.log('Source: ' + source)
        console.log('Target: ' + target)
        console.log('Piece: ' + piece)
        console.log('New position: ' + Chessboard.objToFen(newPos))
        console.log('Old position: ' + Chessboard.objToFen(oldPos))
        console.log('Orientation: ' + orientation)
        console.log('~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~')
        if (source == target) {
            return;
        }
        board.move(source + "-" + target)
        turn = !turn
        updatePlayerTurn()
        performAiMove()
    }

    var board = Chessboard('board', {
        draggable: true,
        dropOffBoard: 'trash',
        // sparePieces: true
        position: 'start', //'4rkr1/1p1Rn1pp/p3pQ2/5p2/8/8/PPq2PPP/3R2K1 b - - 1 1'
        onDrop: onDrop
    })

    function turnChar() {
        return turn ? " w KQkq - 0 1" : " b KQkq - 0 1";
    }

    function performAiMove() {
        let currentFen = board.fen() + turnChar();
        getNewFEN(currentFen, (data) => {
            turn = !turn
            updatePlayerTurn()
            board.position(data.updatedFEN)
            console.log("time:" + data.calculationTimeInSeconds)
            $("#last_time").text("Letzte Antwortzeit: " + Math.round(data.calculationTimeInSeconds) + " Sekunden")
            console.log(data.move)
            $("#last_move").text("Letzter Zug: " + data.move)
        });
    }

    function castle(kingside) {
        if (kingside) {
            console.log("Castle Kingside")
            board.move("e1-g1", "h1-f1")
        } else {
            console.log("Castle Queenside")
            board.move("e1-c1", "a1-d1")
        }
        turn = !turn
        updatePlayerTurn()
        performAiMove()
    }

    $("#castle_kingside_button").on("click", () => castle(true))
    $("#castle_queenside_button").on("click", () => castle(false))
</script>

</html>